# 阿里云 OSS Bundle 功能与开发需求（含 API 参考）

本文档用于指导 `aliyun-object-storage-bundle` 的实现与验收，参考 `huawei-object-storage-bundle` 对齐能力与架构，遵循 KISS/DRY/YAGNI 原则，优先满足业务最常用的上传、下载、公共 URL、分段上传与安全合规需求，并提供一致的开发体验与稳定性保障。

## 目标与范围

- 提供基于阿里云 OSS 的 Flysystem v3 适配器与 Symfony Bundle 集成。
- 自动装饰 FileStorageBundle 的 `FilesystemFactory`，在环境变量齐备时透明切换至 OSS 存储。
- 暴露统一的客户端接口与签名能力，便于服务端生成临时上传策略与预签名 URL。
- 覆盖常见桶与对象管理能力，便于上层业务扩展。
- 提供完善文档、示例与测试，保障可维护性与一致性。

## 非功能性要求

- 可靠性：关键路径（上传、读取、分段上传）具备充分的错误处理、重试与幂等性考虑。
- 性能：大文件上传采用分段与流式；生成签名与 URL 为 O(1) 操作。
- 安全：AK/SK 仅通过环境变量读取；支持服务端加密、临时凭证/临时策略；最小权限原则。
- 可观测性：关键操作记录上下文日志（桶名、Key、耗时、HTTP 状态）。
- 易用性：开箱即用；默认值合理；文档示例完善；与华为包用法一致。
- 兼容性：PHP 8.1+，Symfony 6.4+，Flysystem 3.10+。

## 架构设计

- 适配器层：`AliyunOssAdapter` 实现 `League\Flysystem\FilesystemAdapter`。
- 客户端层：`OssClientInterface` + `OssClient`，封装 HTTP/SDK 调用与签名策略。
- 签名层：`OssSignature`，实现 Header 签名与 POST Policy 生成（HMAC-SHA1）。
- 工厂层：`OssAdapterFactory` 根据运行时环境创建适配器与客户端。
- URL 生成：`PublicUrlGenerator`，基于 endpoint/CNAME/CDN 规则生成公共 URL。
- DI 集成：`DependencyInjection\AliyunObjectStorageExtension` 注册服务并装饰 `FilesystemFactory`。
- 配置：仅使用 `$_ENV` 运行时读取；不引入配置文件（与华为包对齐）。

注：HTTP 调用可采用 `symfony/http-client` 或官方 `aliyuncs/oss-sdk-php`。优先提供内置最小可靠实现（KISS），必要时引入 SDK 支持高级能力。对外接口保持稳定。

## 环境变量与配置

必需：
- `ALIYUN_OSS_ACCESS_KEY_ID`：访问密钥 ID
- `ALIYUN_OSS_ACCESS_KEY_SECRET`：访问密钥 Secret
- `ALIYUN_OSS_BUCKET`：桶名

推荐/可选：
- `ALIYUN_OSS_REGION`：地域（如 `cn-hangzhou`）
- `ALIYUN_OSS_ENDPOINT`：原生域名（如 `oss-cn-hangzhou.aliyuncs.com`）
- `ALIYUN_OSS_PREFIX`：路径前缀（逻辑根目录）
- `ALIYUN_OSS_PUBLIC_DOMAIN`：CNAME/CDN 域名（用于生成公共 URL）
- `ALIYUN_OSS_CNAME_ENABLED`：是否按 CNAME 规则组装 URL（不包含 bucket 前缀）
- `ALIYUN_OSS_INTERNAL`：是否使用内网 endpoint（云上内网传输）

配置生效规则：
- 必需项齐备 → 自动启用 OSS 存储适配器
- 公共 URL 生成优先级：CNAME（PUBLIC_DOMAIN + CNAME_ENABLED）> 原生 endpoint > 不生成

## 主要能力与验收清单

- Flysystem 适配器：
  - 文件：`read`/`write`/`delete`/`copy`/`move`
  - 目录：`listContents`（虚拟）/`deleteDirectory`
  - 元数据：`fileSize`/`lastModified`/`mimeType`
  - 流：`readStream`/`writeStream`
  - 分段上传：大文件上传、`listParts`、`abortMultipartUpload`
  - 追加写：AppendObject（Aliyun 专有）
- URL 生成：
  - CNAME/CDN、自定义域名
  - 原生 endpoint（含内网）
  - 路径前缀拼接、URL 安全编码
- 签名：
  - Header 签名（Authorization: `OSS <AccessKeyId>:<Signature>`）
  - 预签名 URL（带有效期）
  - POST Policy（表单直传，限制大小/MIME/Key 前缀等）
- 桶级能力（按需暴露）：
  - ACL、CORS、Lifecycle、Website、Logging、Versioning、Tagging、Encryption（SSE-OSS/SSE-KMS）、Referer、Policy、Replication（CRR）
- 对象级能力（按需暴露）：
  - 复制、标签管理、恢复归档对象、对象元信息、分片列举、对象版本列举
- 观测与错误处理：
  - 统一异常层（包装业务语义）、HTTP 状态映射、可读的错误消息
  - 关键路径日志（INFO/ERROR），含 request-id 与耗时

## 设计细节

### 1) 客户端与签名

- Canonicalization 与签名：遵循 OSS 签名 V1（HMAC-SHA1）
  - StringToSign = `VERB\nContent-MD5\nContent-Type\nDate\nCanonicalizedOSSHeaders + CanonicalizedResource`
  - Authorization = `OSS <AccessKeyId>:<Signature>`
- 预签名 URL：在 QueryString 中附加 `OSSAccessKeyId/Expires/Signature`
- POST Policy：生成 Base64 Policy 与 `Signature`，结合 `key`、`content-length-range`、`mime`、`expiration` 等条件
- 时钟偏移：必要时通过响应头 `Date` 或外部时间源校准（可选）

### 2) 公共 URL 生成

- CNAME 启用时：`https://<PUBLIC_DOMAIN>/<prefix>/<key>`
- 原生 endpoint：`https://<bucket>.<endpoint>/<prefix>/<key>`
- 内网：当 `INTERNAL=true`，替换 endpoint 为 `*-internal.aliyuncs.com`

### 3) 分段上传

- Initiate → UploadPart(N) → Complete →（失败时）Abort
- PartSize 取决于对象大小与并发能力，默认 5MB 起
- ETag 汇总与顺序校验，确保一致性

### 4) 追加写（AppendObject）

- 维护 `position` 光标（可从 `x-oss-next-append-position` 获取）
- 适用于日志/流式场景，不适用于随机写

### 5) 错误与重试

- 网络瞬时错误与 5xx：指数退避重试（最多 N 次，可配置）
- 4xx：就地失败并返回业务语义异常（含 request-id）
- 对象不存在映射为 NotFound 异常

## API 参考

注：以下为 Bundle 暴露的客户端接口建议方法名与语义，方法签名以 PHP 为准（此处不提供代码，仅描述）。实际暴露的最小闭环需覆盖上传/下载/分段/签名/元数据核心路径，其他能力按需渐进实现。

### 通用类型

- Bucket: `string`
- Key: `string`（允许包含 `/` 作为逻辑目录）
- Stream: `resource|StreamInterface`
- Headers: `array<string,string>`
- Metadata: `array<string,string|int>`

### 对象操作（Object）

- putObject(bucket, key, content|stream, headers?, metadata?) → ETag
- getObject(bucket, key) → stream|bytes
- headObject(bucket, key) → metadata（size, mime, lastModified, etag, user-meta...）
- deleteObject(bucket, key) → void
- copyObject(bucket, dstKey, srcBucket, srcKey, headers?) → ETag
- appendObject(bucket, key, stream|bytes, position, headers?) → nextPosition
- listObjects(bucket, prefix?, delimiter?, maxKeys?, continuationToken?) → { objects[], commonPrefixes[], nextToken? }

### 分段上传（Multipart）

- initiateMultipartUpload(bucket, key, headers?, metadata?) → uploadId
- uploadPart(bucket, key, uploadId, partNumber, stream|bytes, size) → ETag
- listParts(bucket, key, uploadId) → [ { partNumber, etag, size, lastModified } ]
- completeMultipartUpload(bucket, key, uploadId, parts[]) → ETag
- abortMultipartUpload(bucket, key, uploadId) → void

### 预签名与表单直传（签名）

- generatePresignedUrl(bucket, key, expires, method='GET', headers?, query?) → url
- generatePostPolicy(bucket, keyPrefix, expires, conditions={sizeRange?, mime?, acl?}) → { policyBase64, signature, accessKeyId, host, key, successActionStatus }

### 桶操作（Bucket）

- createBucket(bucket, acl?, storageClass?) → void
- deleteBucket(bucket) → void
- headBucket(bucket) → { location, owner?, creationDate? }
- listBuckets(prefix?) → [bucket]
- getBucketLocation(bucket) → region

### 桶配置（Bucket Configuration）

- ACL：putBucketAcl/getBucketAcl
- CORS：putBucketCors/getBucketCors/deleteBucketCors
- Lifecycle：putBucketLifecycle/getBucketLifecycle/deleteBucketLifecycle
- Website：putBucketWebsite/getBucketWebsite/deleteBucketWebsite
- Logging：putBucketLogging/getBucketLogging
- Versioning：putBucketVersioning/getBucketVersioning
- Tagging：putBucketTagging/getBucketTagging/deleteBucketTagging
- Encryption（SSE-OSS/KMS）：putBucketEncryption/getBucketEncryption/deleteBucketEncryption
- Referer：putBucketReferer/getBucketReferer
- Policy：putBucketPolicy/getBucketPolicy/deleteBucketPolicy
- Replication（CRR）：putBucketReplication/getBucketReplication/deleteBucketReplication

（上述接口按需分阶段实现；首期以对象与分段上传、预签名能力为主，桶配置类接口采用延后实现或透传原生 API 的方式。）

## 与华为 OBS 差异点

- 追加写：Aliyun OSS 原生支持 AppendObject；需在适配器层显式暴露
- CNAME：Aliyun 常见 CNAME/CDN 加速，URL 生成需支持去除 bucket 段
- 内网域名：`*-internal.aliyuncs.com` 模式（ECS 同地域）
- 加密标头：SSE-OSS 或 KMS 相关头部与 Huawei SSE 存在命名差异
- 事件/通知：Aliyun 与 MNS/FC 集成方式不同（后续可做扩展，不纳入首期）

## 测试策略

- 单元测试：
  - 签名（Header、URL、POST Policy）
  - URL 生成（CNAME/原生/内网，前缀与编码）
  - 适配器行为（写/读/删/流/元数据，基于假客户端或内存桩）
- 集成测试（可选）：
  - 针对真实 OSS 沙箱桶进行烟雾测试（CI 可跳过）
- 失败路径：
  - 404/403/5xx 映射异常、重试策略
  - 分段上传完整流程与异常分支（重复 complete、重复 abort）

## 日志与可观测性

- 记录：method、bucket、key、httpStatus、latency、requestId（如 `x-oss-request-id`）、retries
- 级别：成功 INFO、失败 ERROR，签名与敏感信息避免明文输出

## 安全与合规

- AK/SK 仅来自环境变量；支持 RAM 最小权限策略
- 临时授权：优先推荐服务端生成预签名 URL/POST Policy，而非长时 AK 直传
- HTTPS 强制；可选开启服务端加密（SSE-OSS/KMS）
- 限制直传策略：大小区间、MIME 白名单、Key 前缀

## 迁移建议（从华为到阿里）

- 环境变量映射：`HUAWEI_OBS_*` → `ALIYUN_OSS_*`
- URL 生成：公共域名优先；原生 endpoint 模式注意域名格式差异
- 加密与 ACL：按阿里云头部与策略名对齐
- 分段上传与流式：调用语义保持一致，替换底层实现

## 开发分期（建议）

- P0：适配器核心（读写删/流/分段）、签名（URL/POST）、URL 生成、最小错误处理
- P1：对象复制/标签/元信息扩展、文件夹便利方法、AppendObject
- P2：桶配置类接口（CORS/Lifecycle/Website/Logging/Versioning/Encryption/Policy/Replication）
- P3：观测增强（指标）、更细粒度的重试与限流、性能优化（并发分片、CRC 校验）

## 文档与示例

- README.zh-CN.md：总览、安装、配置、快速开始、能力列表
- docs/PUBLIC_URL_CONFIGURATION.md：公共 URL 生成策略与最佳实践
- examples（可选）：基础用法与 Symfony 集成示例

---

本文档为实现与验收的唯一准绳之一。严禁将凭据写入代码或配置文件；严禁在日志中泄露敏感信息。实现时优先选择简单、稳定、可维护的方案，必要时以扩展点形式兼容高级能力。

